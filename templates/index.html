<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/styles.css">
    <title>Нефтеперерабатывающее предприятие</title>
</head>
<style>
.spinner-border {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: -.125em;
    border: .25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: .75s linear infinite spinner-border;
}

@keyframes spinner-border {
    to { transform: rotate(360deg); }
}

.visually-hidden {
    position: absolute!important;
    width: 1px!important;
    height: 1px!important;
    padding: 0!important;
    margin: -1px!important;
    overflow: hidden!important;
    clip: rect(0,0,0,0)!important;
    white-space: nowrap!important;
    border: 0!important;
}

.plot-container {
    width: 700px;
    height: 600px;
    overflow-y: scroll;
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-bottom: 2rem;
    scrollbar-width: thin;
    scrollbar-color: #40425c #a5a8e7;
    scroll-behavior: smooth;
}

.plot-group {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1rem;
    background: white;
}

.plot-group h4 {
    margin: 0 0 1rem 0;
    color: #2c3e50;
    font-size: 1.1rem;
}

.plot-image {
    width: 100%;
    max-width: 1000px;
    height: auto;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.equation-header {
    border-bottom: 2px solid #2980b9;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

</style>
<body>
    <div class="title">
        <h1>Нефтеперерабатывающее предприятие</h1>
    </div>
    <div style="width: auto; text-align: left; margin-top: 10px; margin-left: 15px;">
                <div id="up-button" style="display: flex;">
                    <input type="number" id="chanceInput" value="0.2" step="0.01" min="0" max="1">
                    <button id="random">Заполнить случайными переменными</button>
                    <button id="saveValuesToJson"><img src="../static/img/save1.png" width="20px" style="padding: 0;"></button>
                    <button id="loadValuesFromJson"><img src="../static/img/upload1.png" width="20px"></button>
                </div>
                
    </div>
    <div class="tables">
        
        <div class="main-column">
            <table style="border: 1px solid black;">
                <caption>Исследуемые показатели</caption>
                <thead>
                    <tr>
                        <th>Название параметра</th>
                        <th>Значение</th>
                        <th>Нижний Предел</th>
                        <th>Верхний Предел</th>
                        <th>Норм. знаменатель</th>
                    </tr>
                </thead>
                <tbody>
                <tr>
                    <td><b>K<sub>1</sub>:</b> Время испарения ОХВ в районе аварии с пов. земли</td>
                    <td><input type="number" name="" id="L1"></td>
                    <td><input type="number" name="" id="L1_min"></td>
                    <td><input type="number" name="" id="L1_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L1_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>2</sub>:</b> Время ликвидации последствий аварии на ХОО</td>
                    <td><input type="number" name="" id="L2"></td>
                    <td><input type="number" name="" id="L2_min"></td>
                    <td><input type="number" name="" id="L2_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L2_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>3</sub>:</b> Площадь заражения в результате аварии</td>
                    <td><input type="number" name="" id="L3"></td>
                    <td><input type="number" name="" id="L3_min"></td>
                    <td><input type="number" name="" id="L3_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L3_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>4</sub>:</b> Время подхода первичного/вторичного облака к НП</td>
                    <td><input type="number" name="" id="L4"></td>
                    <td><input type="number" name="" id="L4_min"></td>
                    <td><input type="number" name="" id="L4_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L4_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>5</sub>:</b> Потери от первичного облака</td>
                    <td><input type="number" name="" id="L5"></td>
                    <td><input type="number" name="" id="L5_min"></td>
                    <td><input type="number" name="" id="L5_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L5_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>6</sub>:</b> Потери от вторичного облака</td>
                    <td><input type="number" name="" id="L6"></td>
                    <td><input type="number" name="" id="L6_min"></td>
                    <td><input type="number" name="" id="L6_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L6_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>7</sub>:</b> Количество получивших амбулаторную помощь (чел.)</td>
                    <td><input type="number" name="" id="L7"></td>
                    <td><input type="number" name="" id="L7_min"></td>
                    <td><input type="number" name="" id="L7_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L7_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>8</sub>:</b> Количество размещенных в стационаре и реанимации (чел.)</td>
                    <td><input type="number" name="" id="L8"></td>
                    <td><input type="number" name="" id="L8_min"></td>
                    <td><input type="number" name="" id="L8_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L8_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>9</sub>:</b> Количество поражённой техники</td>
                    <td><input type="number" name="" id="L9"></td>
                    <td><input type="number" name="" id="L9_min"></td>
                    <td><input type="number" name="" id="L9_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L9_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>10</sub>:</b> Количество объемов и растворов для обеззараживания местности</td>
                    <td><input type="number" name="" id="L10"></td>
                    <td><input type="number" name="" id="L10_min"></td>
                    <td><input type="number" name="" id="L10_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L10_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>11</sub>:</b> Количество сил и средств для проведения авар.-спасательных работ</td>
                    <td><input type="number" name="" id="L11"></td>
                    <td><input type="number" name="" id="L11_min"></td>
                    <td><input type="number" name="" id="L11_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L11_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>12</sub>:</b> Эффективность системы оповещения</td>
                    <td><input type="number" name="" id="L12"></td>
                    <td><input type="number" name="" id="L12_min"></td>
                    <td><input type="number" name="" id="L12_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L12_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>13</sub>:</b> Количество людей в зоне поражения</td>
                    <td><input type="number" name="" id="L13"></td>
                    <td><input type="number" name="" id="L13_min"></td>
                    <td><input type="number" name="" id="L13_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L13_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>14</sub>:</b> Количество спасателей в зоне поражения</td>
                    <td><input type="number" name="" id="L14"></td>
                    <td><input type="number" name="" id="L14_min"></td>
                    <td><input type="number" name="" id="L14_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L14_norm"></td>
                </tr>
                <tr>
                    <td><b>K<sub>15</sub>:</b> Развитость системы МЧС</td>
                    <td><input type="number" name="" id="L15"></td>
                    <td><input type="number" name="" id="L15_min"></td>
                    <td><input type="number" name="" id="L15_max"></td>
                    
                    <td><input type="number" name="" value="0.7" id="L15_norm"></td>
                </tr>
                </tbody>
            </table>
            
        </div>

        <div class="secondary-column">
            <table style="border: 1px solid black; text-align: center;">
                <caption>Возмущения</caption>
                <tbody id="disturbancesTable">
                    <!-- Строки возмущений будут генерироваться здесь -->
                </tbody>
            </table>
        </div>

        <div class="end-column">
            <table style="text-align: center;">
                <caption>Уравнения</caption>
                <tbody id="equationsTable">
                    <!-- Строки уравнений будут генерироваться здесь -->
                </tbody>
            </table>
        </div>
    </div>

    <div style="width: 100%; text-align: center; margin-top: 10px;">
        <button id="calculate" style="height: 50px;">Вычислить результат</button>
        
    </div>
    <h1 style="margin-top: 30px; margin-left: 20px">Результаты: </h1>
        <div id="results" style="text-align: center; margin-top: 20px;">
            
                <!-- Здесь будут отображаться графики -->
        </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const resultDiv = document.getElementById("results");

            // Получаем результаты из localStorage
            const savedResults = JSON.parse(localStorage.getItem("savedResults")) || { results: [] };

            function formatEquation(equation) {
                    // Разделяем название параметра и уравнение
                    const parts = equation.split(' = ');
                    return {
                        param: parts[0],
                        formula: parts[1]
                    };
                }

                // В части кода где формируем newResult
                const equationsHTML = savedResults.results.equations.map(eq => {
                    const formatted = formatEquation(eq);
                    return `
                        <div class="equation-item">
                            <span class="param-name">${formatted.param} =</span>
                            <span class="equation-text">${formatted.formula}</span>
                        </div>
                    `;
                }).join('');


            // Перебираем результаты в обратном порядке и добавляем их в DOM
            savedResults.results.reverse().forEach(result => {
                const resultItem = `
                    <div class="result-item">
                        <img src="data:image/png;base64,${result.img1}" alt="График 1">
                        <img src="data:image/png;base64,${result.img2}" alt="График 2">
                        <div class="equation-list">
                            <h3 style="margin-top:0; color: #2980b9;">Аппроксимирующие уравнения</h3>
                            ${equationsHTML}
                        </div>
                    </div>
                `;
                resultDiv.innerHTML += resultItem;
            });
        });
    </script>
    <script>
        const numberOfDisturbances = 5; // Количество возмущений
        const numberOfEquations = 55; // Количество уравнений

        async function loadVariables() {
            try {
                // Fetch JSON from the server
                const response = await fetch('/get-json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.functionsInfo;
            } catch (error) {
                console.error('Error loading JSON:', error);
                return [];
            }
        }

        async function generateEquations() {
            const equationsTable = document.getElementById('equationsTable');

            const functionsInfo = await loadVariables();

            functionsInfo.forEach((func, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td class="equation">
                        f<sub>${index + 1}</sub> = <input type="number" id="a${index + 1}">K<sub>${func.variable}</sub>(t)<sup>3</sup> +
                        <input type="number" id="b${index + 1}">K<sub>${func.variable}</sub>(t)<sup>2</sup> +
                        <input type="number" id="c${index + 1}">K<sub>${func.variable}</sub>(t) +
                        <input type="number" id="d${index + 1}">
                    </td>
                `;
                equationsTable.appendChild(row);
            });
        }

        function generateDisturbances() {
            const disturbanceTable = document.getElementById('disturbancesTable');

            function disturbanceTemplate(title, seq) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="disturbance">
                        <h4 style="margin-bottom: 20px; font-weight: 500">${title}</h3>
                        R<sub>${seq}</sub> = <input type="number" id="qa${seq}">t<sup>3</sup> +
                        <input type="number" id="qb${seq}">t<sup>2</sup> +
                        <input type="number" id="qc${seq}">t +
                        <input type="number" id="qd${seq}">
                    </td>
                `;
                disturbanceTable.appendChild(row);
            }
            disturbanceTemplate("Уровень финансирования системы МЧС города", 1);
            disturbanceTemplate("Степень экономического развития города", 2);
            disturbanceTemplate("Степень экономического развития города", 3);
            disturbanceTemplate("Доля современного оборудования на предприятии", 4);
        }

        // Генерируем строки уравнений при загрузке страницы
        document.addEventListener('DOMContentLoaded', generateEquations);
        document.addEventListener('DOMContentLoaded', generateDisturbances);
    </script>
    <script>
        document.getElementById("random").addEventListener("click", randomizeValues);
        function randomizeValues() {
            const chanceInput = document.getElementById("chanceInput").value;
            const zeroChance = parseFloat(chanceInput);

            function getRandomValue() {
                return Math.random();
            }

            function getConditionalRandom() {
                return Math.random() > zeroChance ? getRandomValue() : 0.0;
            }

            for (let i = 1; i <= 15; i++) {
                let randVal = getRandomValue().toFixed(2);
                document.getElementById(`L${i}`).value = randVal;
                document.getElementById(`L${i}_min`).value = randVal / 1.25;
                document.getElementById(`L${i}_max`).value = randVal * 1.25;
            }

            for (let i = 1; i <= 4; i++) {
                document.getElementById(`qa${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`qb${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`qc${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`qd${i}`).value = getConditionalRandom().toFixed(2)
            }

            for (let i = 1; i <= 55; i++) {
                document.getElementById(`a${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`b${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`c${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`d${i}`).value = getConditionalRandom().toFixed(2)
            }
        }
    </script>
    <script>
        document.getElementById("calculate").addEventListener("click", function() {
            const btn = this; // Сохраняем ссылку на кнопку
            const spinner = document.getElementById("spinner"); // Предполагаем что у вас есть элемент с id="spinner"
    
            // Блокируем кнопку и показываем спиннер
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Расчет...';
            if(spinner) spinner.style.display = 'block';
                const formData = new FormData();

            // Собираем значения L1-L15 (startValues) как числа
            const startValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}`).value) || 0;
                startValues.push(value);
            }
            formData.append('startValues', JSON.stringify(startValues));

            // Собираем значения L1-L15 MIN (minValues) как числа
            const minValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}_min`).value) || 0;
                minValues.push(value);
            }
            formData.append('minValues', JSON.stringify(minValues));

            // Собираем значения L1-L15 MAX (maxValues) как числа
            const maxValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}_max`).value) || 0;
                maxValues.push(value);
            }
            formData.append('maxValues', JSON.stringify(maxValues));

            // Собираем значения L1-L15 norm (normValues) как числа
            const normValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}_norm`).value) || 0;
                normValues.push(value);
            }
            formData.append('normValues', JSON.stringify(normValues));

            // Собираем коэффициенты уравнений a1, b1, c1, d1 и т.д. как числа
            const qcoefs = [];
            for (let i = 1; i <= 4; i++) {
                const qa = parseFloat(document.getElementById(`qa${i}`).value) || 0;
                const qb = parseFloat(document.getElementById(`qb${i}`).value) || 0;
                const qc = parseFloat(document.getElementById(`qc${i}`).value) || 0;
                const qd = parseFloat(document.getElementById(`qd${i}`).value) || 0;
                qcoefs.push([qa, qb, qc, qd]);
            }
            formData.append('qcoefs', JSON.stringify(qcoefs));

            // Собираем коэффициенты уравнений a1, b1, c1, d1 и т.д. как числа
            const coefs = [];
            for (let i = 1; i <= 55; i++) {
                const a = parseFloat(document.getElementById(`a${i}`).value) || 0;
                const b = parseFloat(document.getElementById(`b${i}`).value) || 0;
                const c = parseFloat(document.getElementById(`c${i}`).value) || 0;
                const d = parseFloat(document.getElementById(`d${i}`).value) || 0;
                coefs.push([a, b, c, d]);
            }
            formData.append('coefs', JSON.stringify(coefs));


            fetch("/calculate/", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById("results");
                
                function formatEquation(equation) {
                    // Разделяем название параметра и уравнение
                    const parts = equation.split(' = ');
                    return {
                        param: parts[0],
                        formula: parts[1]
                    };
                }

                // Формируем HTML для графиков
                const plotsHTML = data.image1.map((imgBase64, index) => `
                    <div class="plot-group">
                        <h4>Группа графиков ${index + 1}</h4>
                        <img src="data:image/png;base64,${imgBase64}" 
                            alt="Графики группы ${index + 1}" 
                            class="plot-image">
                    </div>
                `).join('');

                // В части кода где формируем newResult
                const equationsHTML = data.equations.map(eq => {
                    const formatted = formatEquation(eq);
                    return `
                        <div class="equation-item">
                            <span class="param-name">${formatted.param} =</span>
                            <span class="equation-text">${formatted.formula}</span>
                        </div>
                    `;
                }).join('');

                // Форматируем новый результат
                const newResult = `
                    <div class="result-item">
                        <div class="plot-container">
                            ${plotsHTML}
                         </div>
                        <img src="data:image/png;base64,${data.image2}" alt="График 2">
                        <div class="equation-list">
                            <h3 style="margin-top:0; color: #2980b9;">Аппроксимирующие уравнения</h3>
                            ${equationsHTML}
                        </div>
                    </div>
                `;

                // Добавляем новый результат в начало
                resultDiv.innerHTML = newResult + resultDiv.innerHTML;

                // Работа с localStorage
                const savedResults = JSON.parse(localStorage.getItem("savedResults")) || { results: [] };

                // Добавляем новые изображения в localStorage
                savedResults.results.unshift({ img1: data.image1, img2: data.image2, equations: data.equations });

                // Ограничиваем количество сохраненных результатов (например, до 10)
                if (savedResults.results.length > 10) {
                    savedResults.results.pop();
                }

                // Сохраняем обновленный список в localStorage
                localStorage.setItem("savedResults", JSON.stringify(savedResults));
            })
            .catch(error => console.error('Ошибка:', error))
            .finally(() => {
                    // Восстанавливаем кнопку в любом случае
                    btn.disabled = false;
                    btn.innerHTML = 'Рассчитать';
                    if(spinner) spinner.style.display = 'none';
                    });
            });
    </script>
    <script>
        document.getElementById("saveValuesToJson").addEventListener("click", function saveToJson() {
            // Собираем значения L1-L15 (startValues) как числа
            const startValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}`).value) || 0;
                startValues.push(value);
            }

            // Собираем значения L1-L15 MiN (minValues) как числа
            const minValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}_min`).value) || 0;
                minValues.push(value);
            }

            // Собираем значения L1-L15 MAX (maxValues) как числа
            const maxValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}_max`).value) || 0;
                maxValues.push(value);
            }

            // Собираем значения L1-L15 norm (normValues) как числа
            const normValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}_norm`).value) || 0;
                normValues.push(value);
            }

            // Собираем коэффициенты уравнений a1, b1, c1, d1 и т.д. как числа
            const qcoefs = [];
            for (let i = 1; i <= 4; i++) {
                const a = parseFloat(document.getElementById(`qa${i}`).value) || 0;
                const b = parseFloat(document.getElementById(`qb${i}`).value) || 0;
                const c = parseFloat(document.getElementById(`qc${i}`).value) || 0;
                const d = parseFloat(document.getElementById(`qd${i}`).value) || 0;
                coefs.push([a, b, c, d]);
            }

            // Собираем коэффициенты уравнений a1, b1, c1, d1 и т.д. как числа
            const coefs = [];
            for (let i = 1; i <= 55; i++) {
                const a = parseFloat(document.getElementById(`a${i}`).value) || 0;
                const b = parseFloat(document.getElementById(`b${i}`).value) || 0;
                const c = parseFloat(document.getElementById(`c${i}`).value) || 0;
                const d = parseFloat(document.getElementById(`d${i}`).value) || 0;
                coefs.push([a, b, c, d]);
            }

            // Создаем объект для сохранения
            const data = {
                startValues,
                minValues,
                maxValues,
                coefs,
                qcoefs,
                normValues
            };

            // Преобразуем объект в JSON строку
            const jsonData = JSON.stringify(data, null, 2);

            // Создаем Blob и ссылку для скачивания
            const blob = new Blob([jsonData], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            // Создаем временную ссылку и инициируем скачивание
            const a = document.createElement("a");
            a.href = url;
            a.download = "data.json"; // Название файла
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        })
    </script>
    <script>
        function loadFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const jsonData = JSON.parse(e.target.result);

                // Заполнение значений в полях
                jsonData.startValues.forEach((value, index) => {
                    document.getElementById(`L${index + 1}`).value = value;
                });

                jsonData.maxValues.forEach((value, index) => {
                    document.getElementById(`L${index + 1}_max`).value = value;
                });

                jsonData.normValues.forEach((value, index) => {
                    document.getElementById(`L${index + 1}_norm`).value = value;
                });

                jsonData.coefs.forEach((coef, index) => {
                    document.getElementById(`a${index + 1}`).value = coef[0];
                    document.getElementById(`b${index + 1}`).value = coef[1];
                    document.getElementById(`c${index + 1}`).value = coef[2];
                    document.getElementById(`d${index + 1}`).value = coef[3];
                });

                jsonData.qcoefs.forEach((coef, index) => {
                    document.getElementById(`qa${index + 1}`).value = coef[0];
                    document.getElementById(`qb${index + 1}`).value = coef[1];
                    document.getElementById(`qc${index + 1}`).value = coef[2];
                    document.getElementById(`qd${index + 1}`).value = coef[3];
                });

                // Удаляем временный input
                event.target.remove();
            };

            reader.readAsText(file);
        }
        document.getElementById('loadValuesFromJson').addEventListener('click', function() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.onchange = loadFromJson;
            fileInput.style.width = 0;
            document.body.appendChild(fileInput); // Добавляем в DOM, чтобы его можно было использовать
            fileInput.click();
        });
    </script>
</body>

</html>
